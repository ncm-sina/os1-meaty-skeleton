#include "disk.h"
#include "fat32.h"
#include <string.h>
#include "memory.h"

// static const uint8_t boot_code[] = {
//     0xFA, 0x31, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB, 0xBE, 0x00, 0x7C, 0xBF, 0x00, 0x06, 0xB9,
//     0x00, 0x02, 0xF3, 0xA4, 0xEA, 0x21, 0x06, 0x00, 0x00, 0xBE, 0xBE, 0x07, 0x38, 0x2E, 0x74, 0x0A,
//     0x80, 0x7E, 0x00, 0x80, 0x74, 0x04, 0x83, 0xC6, 0x10, 0xEB, 0xF1, 0xEB, 0xFE, 0xBF, 0x00, 0x7E,
//     0xB9, 0x00, 0x02, 0xF3, 0xA4, 0xEA, 0x00, 0x7E, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
//     // ... (Truncated for brevity; full 446-byte boot code should be included)
// };

static const uint8_t boot_code[446] = {
    0xFA, 0x31, 0xC0, 0x8E, 0xD0, 0xBC, 0x00, 0x7C, 0xFB, 0xBE, 0x00, 0x7C, 0xBF, 0x00, 0x06, 0xB9,
    0x00, 0x02, 0xF3, 0xA4, 0xEA, 0x21, 0x06, 0x00, 0x00, 0xBE, 0xBE, 0x07, 0x38, 0x2E, 0x74, 0x0A,
    0x80, 0x7E, 0x00, 0x80, 0x74, 0x04, 0x83, 0xC6, 0x10, 0xEB, 0xF1, 0xEB, 0xFE, 0xBF, 0x00, 0x7E,
    0xB9, 0x00, 0x02, 0xF3, 0xA4, 0x50, 0x68, 0x1C, 0x06, 0xCB, 0xBB, 0x00, 0x00, 0xB8, 0x01, 0x02,
    0xCD, 0x13, 0x72, 0x10, 0x81, 0xBF, 0xFE, 0x7D, 0x55, 0xAA, 0x75, 0x08, 0xFF, 0xE7, 0xBE, 0x86,
    0x7C, 0xE8, 0x07, 0x00, 0xEB, 0xFE, 0xB4, 0x0E, 0xAC, 0x3C, 0x00, 0x74, 0xF9, 0xCD, 0x10, 0xEB,
    0xF6, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};


int disk_create_partition(Disk* disk, uint32_t start_lba, uint32_t size) {
    MBR mbr;
    memset(&mbr, 0, sizeof(MBR));

    memcpy(mbr.boot_code, boot_code, sizeof(boot_code));
    mbr.partitions[0].status = 0x80;
    mbr.partitions[0].type = 0x0C;
    mbr.partitions[0].start_lba = start_lba;
    mbr.partitions[0].size = size;
    mbr.partitions[0].start_chs[0] = 0xFE;
    mbr.partitions[0].start_chs[1] = 0xFF;
    mbr.partitions[0].start_chs[2] = 0xFF;
    mbr.partitions[0].end_chs[0] = 0xFE;
    mbr.partitions[0].end_chs[1] = 0xFF;
    mbr.partitions[0].end_chs[2] = 0xFF;
    mbr.signature = 0xAA55;

    return (ahci_write_sectors(disk, 0, 1, &mbr));
}

int disk_install_grub(Disk* disk, uint32_t partition_lba) {
    uint8_t* core_img = NULL;
    uint32_t core_size = 0;

    if (fat32_read_file("/boot/grub/core.img", core_img [128], &core_size) != 0) {
        return -1;
    }
    core_img = kmalloc(core_size);
    if (fat32_read_file("/boot/grub/core.img", core_img, &core_size) != 0) {
        kfree(core_img);
        return -1;
    }

    uint32_t sectors = (core_size + 511) / 512;
    if (ahci_write_sectors(disk, partition_lba + 1, sectors, core_img) != 0) {
        kfree(core_img);
        return -1;
    }
    kfree(core_img);
    return 0;
}